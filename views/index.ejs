<!DOCTYPE html>
<html lang="en" class="<%= meta && meta.darkMode ? 'dark' : '' %>">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <meta name="theme-color" content="#0f172a" />
    <script>
      // Prefer theme from localStorage before paint
      (function() {
        try {
          const theme = localStorage.getItem('theme') || 'system';
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          const isDark = theme === 'dark' || (theme === 'system' && prefersDark);
          if (isDark) document.documentElement.classList.add('dark');
        } catch (e) {}
      })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8',
                500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81'
              }
            }
          }
        }
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
      .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
      .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(100,116,139,.5); border-radius: 9999px; }
      .btn { display:inline-flex; align-items:center; gap:0.5rem; border-radius:0.5rem; padding:0.5rem 0.75rem; font-size:0.875rem; font-weight:600; transition: background-color .2s, color .2s, border-color .2s; }
      .btn-primary { background:#4f46e5; color:#fff; }
      .btn-primary:hover { background:#4338ca; }
      .btn-soft { background:#f1f5f9; color:#334155; }
      .btn-soft:hover { background:#e2e8f0; }
      .dark .btn-soft { background:#334155; color:#e2e8f0; }
      .dark .btn-soft:hover { background:#475569; }
      .chip { display:inline-flex; align-items:center; gap:0.5rem; border-radius:9999px; padding:0.25rem 0.75rem; font-size:0.75rem; font-weight:600; background:#f1f5f9; color:#334155; }
      .dark .chip { background:#334155; color:#e2e8f0; }
    </style>
  </head>
  <body class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">
    <!-- Initial Page Loader -->
    <div id="page-loader" class="fixed inset-0 z-50 grid place-items-center bg-white dark:bg-slate-900">
      <div class="flex flex-col items-center gap-4">
        <div class="h-14 w-14 rounded-2xl bg-gradient-to-tr from-brand-500 to-indigo-500 animate-pulse"></div>
        <p class="text-sm text-slate-500 dark:text-slate-400">Loading Realtime Notesâ€¦</p>
      </div>
    </div>

    <!-- App Shell -->
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside id="sidebar" class="w-72 shrink-0 border-r border-slate-200 dark:border-slate-800 bg-white/60 dark:bg-slate-900/60 backdrop-blur hidden md:block">
        <div class="p-4 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="h-8 w-8 rounded-xl bg-gradient-to-tr from-brand-500 to-indigo-500"></div>
            <h1 class="text-lg font-semibold">Realtime Notes</h1>
          </div>
          <button id="theme-toggle" class="btn btn-soft" title="Toggle theme">
            <span class="i">ðŸŒ™</span>
          </button>
        </div>
        <div class="px-4">
          <input id="search" type="text" placeholder="Search notesâ€¦" class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 text-sm" />
        </div>
        <nav class="mt-4 px-2 space-y-1" id="filters">
          <button data-group="all" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 font-medium">All Notes</button>
          <button data-group="ungrouped" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">Ungrouped</button>
          <button data-group="deleted" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">Recycle Bin</button>
        </nav>
        <div class="mt-6 px-4 flex items-center justify-between">
          <h2 class="text-xs uppercase tracking-wider text-slate-500">Groups</h2>
          <button id="add-group" class="text-xs text-brand-600 hover:underline">Add</button>
        </div>
        <div id="group-list" class="mt-2 px-2 space-y-1 max-h-[40vh] overflow-auto scrollbar-thin"></div>
      </aside>

      <!-- Main -->
      <main class="flex-1">
        <header class="md:hidden px-4 py-3 flex items-center justify-between sticky top-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur border-b border-slate-200 dark:border-slate-800 z-10">
          <div class="flex items-center gap-2">
            <button id="mobile-menu" class="btn btn-soft">â˜°</button>
            <h1 class="font-semibold">Realtime Notes</h1>
          </div>
          <button id="theme-toggle-m" class="btn btn-soft">ðŸŒ™</button>
        </header>

        <section class="p-4 md:p-6">
          <!-- Composer -->
          <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/60 dark:bg-slate-900/60 p-4 md:p-5 shadow-sm">
            <div class="flex flex-col md:flex-row md:items-center gap-3">
              <input id="note-title" type="text" placeholder="Note titleâ€¦" class="flex-1 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 text-sm" />
              <select id="note-group" class="rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 text-sm min-w-[140px]">
                <option value="">No group</option>
              </select>
              <div class="flex items-center gap-1">
                <button data-cmd="bold" class="btn btn-soft" title="Bold"><b>B</b></button>
                <button data-cmd="italic" class="btn btn-soft" title="Italic"><i>I</i></button>
                <button data-cmd="underline" class="btn btn-soft" title="Underline"><u>U</u></button>
              </div>
              <button id="create-note" class="btn btn-primary">Add Note</button>
            </div>
            <div id="editor" contenteditable="true" class="mt-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 text-sm min-h-[84px]"></div>
          </div>

          <!-- Toolbar -->
          <div class="mt-6 flex flex-wrap items-center gap-2">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="select-all" type="checkbox" class="h-4 w-4" /> Select all
            </label>
            <div class="grow"></div>
            <div id="toolbar-actions" class="flex flex-wrap items-center gap-2">
              <!-- dynamic by context -->
            </div>
          </div>

          <!-- Notes List -->
          <div id="notes-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>

          <!-- Skeleton -->
          <template id="skeleton-card">
            <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/60 dark:bg-slate-900/60 p-4 animate-pulse">
              <div class="h-4 w-2/3 bg-slate-200 dark:bg-slate-700 rounded"></div>
              <div class="mt-3 space-y-2">
                <div class="h-3 w-full bg-slate-200 dark:bg-slate-700 rounded"></div>
                <div class="h-3 w-5/6 bg-slate-200 dark:bg-slate-700 rounded"></div>
                <div class="h-3 w-4/6 bg-slate-200 dark:bg-slate-700 rounded"></div>
              </div>
              <div class="mt-4 h-8 w-24 bg-slate-200 dark:bg-slate-700 rounded"></div>
            </div>
          </template>
        </section>
      </main>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-40 hidden">
      <div class="absolute inset-0 bg-black/40" data-close="modal"></div>
      <div class="absolute inset-x-4 md:inset-x-auto md:left-1/2 md:-translate-x-1/2 top-20 md:w-[720px] rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Edit Note</h3>
          <button class="btn btn-soft" data-close="modal">âœ•</button>
        </div>
        <div class="mt-3 space-y-3">
          <input id="edit-title" class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 text-sm" />
          <select id="edit-group" class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 text-sm">
            <option value="">No group</option>
          </select>
          <div class="flex items-center gap-1">
            <button data-editcmd="bold" class="btn btn-soft"><b>B</b></button>
            <button data-editcmd="italic" class="btn btn-soft"><i>I</i></button>
            <button data-editcmd="underline" class="btn btn-soft"><u>U</u></button>
          </div>
          <div id="edit-editor" contenteditable="true" class="rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2 text-sm min-h-[140px]"></div>
        </div>
        <div class="mt-4 flex items-center justify-end gap-2">
          <button class="btn btn-soft" data-close="modal">Cancel</button>
          <button id="edit-save" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/public/js/main.js" type="module"></script>
  </body>
</html>
